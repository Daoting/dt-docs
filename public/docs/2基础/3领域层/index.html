<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>领域层 - 搬运工</title>
        <meta name="Description" content="利用 C# &#43; XAML 进行快速业务开发的跨平台框架">
        <meta name="application-name" content="搬运工">
        <meta name="apple-mobile-web-app-title" content="搬运工">
        <meta name="theme-color" content="#ffffff">
        <meta name="msapplication-TileColor" content="#da532c">
        <link rel="shortcut icon" type="image/x-icon" href="/dt-docs/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/dt-docs/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/dt-docs/favicon-16x16.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/dt-docs/apple-touch-icon.png">
        <link rel="mask-icon" href="/dt-docs/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="manifest" href="/dt-docs/site.webmanifest">
        <link rel="canonical" href="https://daotingh.gitee.io/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/" />
        <link rel="alternate" href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/index.xml" type="application/rss+xml" title="搬运工">
        <link rel="feed" href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/index.xml" type="application/rss+xml" title="搬运工"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/dt-docs/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    </head>
    <body data-header-desktop="fixed" data-header-mobile="auto">
        <script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>
        <div id="mask"></div>
        <div class="wrapper">
            <header class="desktop" id="header-desktop">
                <div class="header-wrapper">
                    <div class="header-title">
                        <a href="/dt-docs/" title="搬运工"><img class="lazyload logo" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/favicon-32x32.png" data-srcset="/dt-docs/favicon-32x32.png, /dt-docs/favicon-32x32.png 1.5x, /dt-docs/favicon-32x32.png 2x" data-sizes="auto" alt="/dt-docs/favicon-32x32.png" title="/dt-docs/favicon-32x32.png" />搬运工</a>
                    </div>
                    <div class="menu">
                        <div class="menu-inner"><a class="menu-item" href="/dt-docs/posts/"> 文章 </a><a class="menu-item" href="/dt-docs/docs/"> 教程 </a><a class="menu-item" href="https://github.com/daoting/dt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span>
                            <span class="menu-item search" id="search-desktop">
                                <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                                <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                                    <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                                </a>
                                <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                                    <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                                </a>
                                <span class="search-button search-loading" id="search-loading-desktop">
                                    <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                                </span>
                            </span>
                            <a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </header>
            <header class="mobile" id="header-mobile">
                <div class="header-container">
                    <div class="header-wrapper">
                        <div class="header-title">
                            <a href="/dt-docs/" title="搬运工"><img class="lazyload logo" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/favicon-32x32.png" data-srcset="/dt-docs/favicon-32x32.png, /dt-docs/favicon-32x32.png 1.5x, /dt-docs/favicon-32x32.png 2x" data-sizes="auto" alt="/dt-docs/favicon-32x32.png" title="/dt-docs/favicon-32x32.png" />搬运工</a>
                        </div>
                        <div class="menu-toggle" id="menu-toggle-mobile">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                    <div class="menu" id="menu-mobile">
                        <div class="search-wrapper">
                            <div class="search mobile" id="search-mobile">
                                <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                                <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                                    <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                                </a>
                                <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                                    <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                                </a>
                                <span class="search-button search-loading" id="search-loading-mobile">
                                    <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                                </span>
                            </div>
                            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                                取消
                            </a>
                        </div>
                        <a class="menu-item" href="/dt-docs/posts/" title="">文章</a>
                        <a class="menu-item" href="/dt-docs/docs/" title="">教程</a>
                        <a class="menu-item" href="https://github.com/daoting/dt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a>
                        <a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                            <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </header>
            <div class="search-dropdown desktop">
                <div id="search-dropdown-desktop"></div>
            </div>
            <div class="search-dropdown mobile">
                <div id="search-dropdown-mobile"></div>
            </div>
            <main class="main"><div class="doc-frame">
    <aside class="doc-tree">
        <div id="content-mobile">
  <button class="fas fa-bars" type="button" onclick="var nav = document.getElementById('td-section-nav'); nav.style.display = (nav.style.display == 'block') ? 'none' : 'block' ">
  </button>
</div>
<nav class="td-sidebar-nav" id="td-section-nav">
  <ul class="td-sidebar-nav__section">
    <li>
  <a href="/dt-docs/docs/" title="概述" class="td-sidebar-link tree-root"><span>概述</span></a>
  <ul  class="ul-1" >
    <li>
  <a href="/dt-docs/docs/1%E5%BC%80%E5%A7%8B/" title="开始" class="td-sidebar-link"><span>开始</span></a>
  <ul >
    <li>
  <a href="/dt-docs/docs/1%E5%BC%80%E5%A7%8B/1%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" title="开发环境" class="td-sidebar-link"><span>开发环境</span></a>
</li><li>
  <a href="/dt-docs/docs/1%E5%BC%80%E5%A7%8B/2%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE/" title="创建空项目" class="td-sidebar-link"><span>创建空项目</span></a>
</li><li>
  <a href="/dt-docs/docs/1%E5%BC%80%E5%A7%8B/3%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80/" title="小试牛刀" class="td-sidebar-link"><span>小试牛刀</span></a>
</li><li>
  <a href="/dt-docs/docs/1%E5%BC%80%E5%A7%8B/4%E6%90%AC%E8%BF%90%E5%B7%A5%E6%A0%B7%E4%BE%8B/" title="搬运工样例" class="td-sidebar-link"><span>搬运工样例</span></a>
</li>
  </ul>
</li><li>
  <a href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/" title="基础" class="td-sidebar-link"><span>基础</span></a>
  <ul >
    <li>
  <a href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/1%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84/" title="总体架构" class="td-sidebar-link"><span>总体架构</span></a>
</li><li>
  <a href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/2%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD/" title="基础功能" class="td-sidebar-link"><span>基础功能</span></a>
</li><li>
  <a href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/" title="领域层" class="td-sidebar-link active"><span>领域层</span></a>
</li><li>
  <a href="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/4%E6%9C%8D%E5%8A%A1/" title="服务" class="td-sidebar-link"><span>服务</span></a>
</li>
  </ul>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/" title="客户端" class="td-sidebar-link"><span>客户端</span></a>
  <ul >
    <li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/1%E5%9F%BA%E7%A1%80/" title="基础" class="td-sidebar-link"><span>基础</span></a>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/2%E7%95%8C%E9%9D%A2%E6%A1%86%E6%9E%B6/" title="界面框架" class="td-sidebar-link"><span>界面框架</span></a>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/3fv/" title="Fv" class="td-sidebar-link"><span>Fv</span></a>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/4lv/" title="Lv" class="td-sidebar-link"><span>Lv</span></a>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/5tab/" title="Tab" class="td-sidebar-link"><span>Tab</span></a>
</li><li>
  <a href="/dt-docs/docs/3%E5%AE%A2%E6%88%B7%E7%AB%AF/6%E5%9F%BA%E7%A1%80%E6%8E%A7%E4%BB%B6/" title="基础控件" class="td-sidebar-link"><span>基础控件</span></a>
</li>
  </ul>
</li><li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/" title="发布部署" class="td-sidebar-link"><span>发布部署</span></a>
  <ul >
    <li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/1%E6%9C%8D%E5%8A%A1/" title="服务" class="td-sidebar-link"><span>服务</span></a>
</li><li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/2win%E5%BA%94%E7%94%A8/" title="Win应用" class="td-sidebar-link"><span>Win应用</span></a>
</li><li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/3android%E5%BA%94%E7%94%A8/" title="Android应用" class="td-sidebar-link"><span>Android应用</span></a>
</li><li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/4ios%E5%BA%94%E7%94%A8/" title="iOS应用" class="td-sidebar-link"><span>iOS应用</span></a>
</li><li>
  <a href="/dt-docs/docs/4%E5%8F%91%E5%B8%83%E9%83%A8%E7%BD%B2/5wasm%E5%BA%94%E7%94%A8/" title="Wasm应用" class="td-sidebar-link"><span>Wasm应用</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
  </ul>
</nav>


    </aside>
    <div class="doc-main">
        <div class="container">
            <article class="page single"><h1 class="single-title animate__animated animate__flipInX">领域层</h1><div class="post-meta">
                    <div class="post-meta-line">
                        <i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 14615 字&nbsp;
                        <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 30 分钟&nbsp;</div>
                </div><div class="content" id="content"><p>领域层是业务开发过程中的重要部分，包括实体、实体读写、业务逻辑、领域服务等，并且实现<strong>客户端领域层和服务端领域层代码相同</strong>，既可以将业务放在客户端处理也可以稍加修改放在服务端处理。但系统未采用DDD模式的聚合根、值对象、仓库等概念，不再区分聚合根、值对象等类型，实体之间的关系可自定义调整。</p>
<h2 id="实体">实体</h2>
<p>遵循<code>ORM</code>的映射规则，实体类和数据库中的表或视图一一映射。</p>
<p>一个实体类分3个文件：<code>.tbl.cs  .sql.cs  .cs</code>，可通过VS扩展工具自动生成，<code>.tbl.cs</code>文件包括表的映射属性和构造方法，表结构修改时需要重新生成，因此不可手动修改，避免被覆盖。
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/7.png" width="475" height="466" />
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/4.png" width="263" height="446" />
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="na">[Tbl(&#34;demo_crud&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CrudX</span> <span class="p">:</span> <span class="n">EntityX</span><span class="p">&lt;</span><span class="n">CrudX</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#region 构造方法</span>
</span></span><span class="line"><span class="cl">    <span class="n">CrudX</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">CrudX</span><span class="p">(</span><span class="n">CellList</span> <span class="n">p_cells</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">p_cells</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">CrudX</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">Name</span> <span class="p">=</span> <span class="k">default</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">Dispidx</span> <span class="p">=</span> <span class="k">default</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">DateTime</span> <span class="n">Mtime</span> <span class="p">=</span> <span class="k">default</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">EnableInsertEvent</span> <span class="p">=</span> <span class="k">default</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">EnableNameChangedEvent</span> <span class="p">=</span> <span class="k">default</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">EnableDelEvent</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;ID&#34;</span><span class="p">,</span> <span class="n">ID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;Name&#34;</span><span class="p">,</span> <span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;Dispidx&#34;</span><span class="p">,</span> <span class="n">Dispidx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;Mtime&#34;</span><span class="p">,</span> <span class="n">Mtime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;EnableInsertEvent&#34;</span><span class="p">,</span> <span class="n">EnableInsertEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;EnableNameChangedEvent&#34;</span><span class="p">,</span> <span class="n">EnableNameChangedEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddCell</span><span class="p">(</span><span class="s">&#34;EnableDelEvent&#34;</span><span class="p">,</span> <span class="n">EnableDelEvent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IsAdded</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span><span class="n">endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 名称</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="k">this</span><span class="p">[</span><span class="s">&#34;Name&#34;</span><span class="p">];</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span> <span class="p">{</span> <span class="k">this</span><span class="p">[</span><span class="s">&#34;Name&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<p><code>.tbl.cs</code>文件中类的标签有两种：<code>Tbl</code> <code>Sqlite</code>，对应远程库和本地<code>sqlite</code>库，除标签不同外，领域层的所有操作不区分远程库和本地 <code>Sqlite</code>库，实体读写、业务逻辑、领域服务写法完全相同：
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="hl"><span class="lnt">2
</span></span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="hl"><span class="lnt">6
</span></span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="c1">// 该实体是表 demo_crud 的映射，可通过 demo 服务进行数据读写</span>
</span></span><span class="line hl"><span class="cl"><span class="na">[Tbl(&#34;demo_crud&#34;, &#34;demo&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CrudX</span> <span class="p">:</span> <span class="n">EntityX</span><span class="p">&lt;</span><span class="n">CrudX</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 该实体存储在 local 库的 Crud 表</span>
</span></span><span class="line hl"><span class="cl"><span class="na">[Sqlite(&#34;local&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CrudX</span> <span class="p">:</span> <span class="n">EntityX</span><span class="p">&lt;</span><span class="n">CrudX</span><span class="p">&gt;</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p><code>Tbl</code>标签的参数有两个，第一个是表名，第二个是服务名，服务名可以在表注释中以<code>#svcname#</code>为开头定义，这样自动生成实体类的标签中包含了服务名，否则请手动填写。</p>
<p><img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/37.png" width="620" height="60" /></p>
</div>
        </div>
    </div>
<h2 id="业务逻辑">业务逻辑</h2>
<p><code>.cs</code>文件存放业务逻辑或静态辅助方法，只在初次自动生成。实体类默认以<code>X</code>为后缀，避免重名且方便识别。</p>
<p>重写<code>InitHook</code>方法，注册回调，可以进行业务校验或添加领域事件</p>
<ul>
<li><code>OnSaving</code>保存前</li>
<li><code>OnSaved</code>保存后</li>
<li><code>OnDeleting</code>删除前</li>
<li><code>OnDeleted</code>删除后</li>
<li><code>OnChanging</code>属性值变化前</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CrudX</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">CrudX</span><span class="p">&gt;</span> <span class="n">New</span><span class="p">(</span><span class="kt">string</span> <span class="n">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CrudX</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ID</span><span class="p">:</span> <span class="k">await</span> <span class="n">NewID</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Name</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Dispidx</span><span class="p">:</span> <span class="k">await</span> <span class="n">NewSeq</span><span class="p">(</span><span class="s">&#34;Dispidx&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Mtime</span><span class="p">:</span> <span class="n">Kit</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">InitHook</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnSaving</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">IsAdded</span> <span class="p">&amp;&amp;</span> <span class="n">EnableInsertEvent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">InsertCrudEvent</span> <span class="p">{</span> <span class="n">ID</span> <span class="p">=</span> <span class="n">ID</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(!</span><span class="n">IsAdded</span>
</span></span><span class="line"><span class="cl">                <span class="p">&amp;&amp;</span> <span class="n">EnableNameChangedEvent</span>
</span></span><span class="line"><span class="cl">                <span class="p">&amp;&amp;</span> <span class="n">_cells</span><span class="p">[</span><span class="s">&#34;Name&#34;</span><span class="p">].</span><span class="n">IsChanged</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">NameChangedEvent</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 保存后信息丢失</span>
</span></span><span class="line"><span class="cl">                    <span class="n">OriginalVal</span> <span class="p">=</span> <span class="n">_cells</span><span class="p">[</span><span class="s">&#34;Name&#34;</span><span class="p">].</span><span class="n">GetOriginalVal</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">NewVal</span> <span class="p">=</span> <span class="n">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnSaved</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">ClearCache</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Phone</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnDeleting</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">EnableDelEvent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AddEvent</span><span class="p">(</span><span class="k">new</span> <span class="n">DelCrudEvent</span> <span class="p">{</span> <span class="n">Tgt</span> <span class="p">=</span> <span class="k">this</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnDeleted</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">ClearCache</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Phone</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">OnChanging</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Name</span><span class="p">),</span> <span class="n">v</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Kit.Msg(&#34;Name新值：&#34; + v);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>若是父实体，可在<code>.cs</code>文件中增加子实体列表属性，并添加<code>ChildX</code>标签，指明父表外键属性名：
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt">1
</span></span><span class="lnt">2
</span><span class="lnt">3
</span><span class="hl"><span class="lnt">4
</span></span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line hl"><span class="cl"><span class="na">[ChildX(&#34;ParentID&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="n">Table</span><span class="p">&lt;</span><span class="n">ChildTbl1X</span><span class="p">&gt;</span> <span class="n">Tbl1</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line hl"><span class="cl"><span class="na">[ChildX(&#34;GroupID&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="n">Table</span><span class="p">&lt;</span><span class="n">ChildTbl2X</span><span class="p">&gt;</span> <span class="n">Tbl2</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<p><code>OnSaving</code>和<code>OnDeleting</code>在写数据前调用，返回<code>Task</code>，通过抛出异常来禁止写数据，<code>OnSaving</code>回调使用场景较多，如保存前的校验(如不可为空、重名、数据不符合业务规则等)、数据完善(如修改时间)、还可触发领域事件。</p>
<p><code>OnChanging</code>回调是属性值(Cell值)改变时的钩子方法，若实体类中包含某属性的钩子方法，所有对<code>Cell.Val</code>的赋值都会调用钩子方法，包括UI的绑定，主要用于：数据校验不符合业务抛异常使赋值失败、和其他列值的联动。</p>
<p><code>OnSaved</code>和<code>OnDeleted</code>在写数据后调用，一般用来做善后工作，如清除缓存。</p>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">禁止实体类中涉及UI和持久化功能</div>
        </div>
    </div>
<h2 id="构造实体">构造实体</h2>
<p>构造实体的方法：</p>
<ol>
<li>
<p>调用<code>New</code>静态方法或直接<code>new</code></p>
</li>
<li>
<p>通过<code>Entity</code>静态方法查询数据创建实体
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 借用泛型参数 TEntity 实现通用的静态方法</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型参数&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">EntityX</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Entity</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 查询实体列表，可以提供 where子句 或 Sql字典的键名 或 Sql语句进行查询</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_whereOrKeyOrSql&#34;&gt;三种查询：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. where子句，以where开头的过滤条件，返回的实体包含所有列值&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. Sql键名或Sql语句，自由查询，返回的实体列值自由&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. null时返回所有实体&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体列表&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;&gt;</span> <span class="n">Query</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_whereOrKeyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 按页查询实体列表，可以提供 where子句 或 Sql字典的键名 或 Sql语句进行查询</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_starRow&#34;&gt;起始行号：mysql中第一行为0行&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_pageSize&#34;&gt;每页显示行数&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_whereOrKeyOrSql&#34;&gt;三种查询：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. where子句，以where开头的过滤条件，返回的实体包含所有列值&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. Sql键名或Sql语句，自由查询，返回的实体列值自由&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. null时返回所有实体&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体列表&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;&gt;</span> <span class="n">Page</span><span class="p">(</span><span class="kt">int</span> <span class="n">p_starRow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_pageSize</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_whereOrKeyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 返回第一个实体对象，不存在时返回null，可以提供 where子句 或 Sql字典的键名 或 Sql语句进行查询</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_whereOrKeyOrSql&#34;&gt;三种查询：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. where子句，以where开头的过滤条件，返回的实体包含所有列值&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. Sql键名或Sql语句，自由查询，返回的实体列值自由&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. null时返回第一个实体&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体对象或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">First</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_whereOrKeyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 根据主键获得实体对象(包含所有列值)，仅支持单主键</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_id&#34;&gt;主键值&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体对象或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetByID</span><span class="p">(</span><span class="kt">object</span> <span class="n">p_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 根据主键或唯一索引列获得实体对象(包含所有列值)，仅支持单主键</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyName&#34;&gt;主键或唯一索引列名&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyVal&#34;&gt;键值&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体对象或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetByKey</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_keyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_keyVal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 根据主键获得实体对象及所有子实体列表，仅支持单主键，不涉及缓存！</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_id&#34;&gt;主键&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体对象或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetByIDWithChild</span><span class="p">(</span><span class="kt">object</span> <span class="n">p_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 根据主键或唯一索引值优先从缓存中获取实体，获取过程：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 首先从缓存中获取，有则直接返回&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 无则查询数据库，并将查询结果添加到缓存以备下次使用&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyName&#34;&gt;主键或唯一索引列名，确保缓存中键名的唯一&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyVal&#34;&gt;键值&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetFromCacheFirst</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_keyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_keyVal</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
</li>
<li>
<p>通过AtXxx静态方法查询数据创建实体
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 数据访问基类，为方便使用所有方法为静态，通过 TAccessInfo 提供实际的数据查询对象</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;typeparam name=&#34;TAccessInfo&#34;&gt;数据访问的描述信息&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DataAccess</span><span class="p">&lt;</span><span class="n">TAccessInfo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TAccessInfo</span> <span class="p">:</span> <span class="n">AccessInfo</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 以参数值方式执行Sql语句，返回结果集</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回Table数据&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&gt;</span> <span class="n">Query</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 以参数值方式执行Sql语句，返回实体列表</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体列表&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;&gt;</span> <span class="n">Query</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 按页查询数据</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_starRow&#34;&gt;起始行号：mysql中第一行为0行&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_pageSize&#34;&gt;每页显示行数&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回Table数据&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&gt;</span> <span class="n">Page</span><span class="p">(</span><span class="kt">int</span> <span class="n">p_starRow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_pageSize</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 按页查询数据</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_starRow&#34;&gt;起始行号：mysql中第一行为0行&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_pageSize&#34;&gt;每页显示行数&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回Table数据集&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;&gt;</span> <span class="n">Page</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="kt">int</span> <span class="n">p_starRow</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p_pageSize</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 以参数值方式执行Sql语句，只返回第一行数据</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回第一行Row或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Row</span><span class="p">&gt;</span> <span class="n">First</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 以参数值方式执行Sql语句，返回第一个实体对象，实体属性由Sql决定，不存在时返回null</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_keyOrSql&#34;&gt;Sql字典中的键名(无空格) 或 Sql语句&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_params&#34;&gt;参数值，支持Dict或匿名对象，默认null&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;返回实体对象或null&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">First</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
</li>
</ol>
<p><code>EntityX</code>和<code>AtXxx</code>的静态查询方法都是调用数据访问层的读数据方法，这些代理方法最终通过<code>Rpc调用</code>或<code>Sqlite读写</code>实现。
实体类继承自<code>EntityX&lt;T&gt;</code>，将当前实体类型作为泛型参数，使静态方法不再需要泛型参数就实现通用，省去在每个实体类都生成相同的静态方法。
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="hl"><span class="lnt">1
</span></span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="hl"><span class="lnt">8
</span></span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line hl"><span class="cl"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">CrudX</span> <span class="p">:</span> <span class="n">EntityX</span><span class="p">&lt;</span><span class="n">CrudX</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">EntityX</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Entity</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line hl"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;&gt;</span> <span class="n">Query</span><span class="p">(</span><span class="kt">string</span> <span class="n">p_whereOrKeyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>当使用通用静态方法查询数据创建实体时，每个查询只是sql和参数不同，这些查询很多时候是需要复用的，通常将这些查询封装成静态方法放在<code>.cs</code>文件，将用到的sql语句放在<code>.sql.cs</code>文件，因此<code>.cs</code>文件内容主要包括三类：</p>
<ol>
<li>重写InitHook方法，存放业务逻辑；</li>
<li>静态New方法，构造实体；</li>
<li>可复用的静态查询方法，构造实体列表；</li>
</ol>
<p>为何将用到的sql语句放在<code>.sql.cs</code>文件？</p>
<ol>
<li>sql语句作为字符串直接混在代码中显的比较乱；</li>
<li>复杂的sql语句不换行阅读困难；</li>
<li>若多行的sql语句混杂引号，需要复制sql语句放在工具中调试时困难；</li>
</ol>
<p>以下为<code>.sql.cs</code>文件中sql语句的通用写法：</p>
<ol>
<li>sql语句作为常量字符串 const string；</li>
<li>以@标记的字符串；</li>
<li>sql语句多行时第一行和最后行都为空，方便复制调试；</li>
<li>常量名以Sql开头，推荐用中文，方便理解；</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl">    <span class="k">partial</span> <span class="k">class</span> <span class="nc">WfdDs</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 用户在一个流程实例中参与的所有任务</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">string</span> <span class="n">Sql</span><span class="err">所有经办历史任务</span> <span class="p">=</span> <span class="s">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">select wi.id item_id,
</span></span></span><span class="line"><span class="cl"><span class="s">       pi.id prci_id,
</span></span></span><span class="line"><span class="cl"><span class="s">       pd.id prcd_id,
</span></span></span><span class="line"><span class="cl"><span class="s">       ad.id atvd_id,
</span></span></span><span class="line"><span class="cl"><span class="s">       ai.id atvi_id,
</span></span></span><span class="line"><span class="cl"><span class="s">       pd.name prcname,
</span></span></span><span class="line"><span class="cl"><span class="s">       ad.name atvname,
</span></span></span><span class="line"><span class="cl"><span class="s">       pi.status,
</span></span></span><span class="line"><span class="cl"><span class="s">       pi.name formname,
</span></span></span><span class="line"><span class="cl"><span class="s">       wi.sender,
</span></span></span><span class="line"><span class="cl"><span class="s">       wi.stime,
</span></span></span><span class="line"><span class="cl"><span class="s">       wi.mtime,
</span></span></span><span class="line"><span class="cl"><span class="s">       wi.reCount
</span></span></span><span class="line"><span class="cl"><span class="s">from cm_wfi_atv ai,
</span></span></span><span class="line"><span class="cl"><span class="s">     cm_wfi_prc pi,
</span></span></span><span class="line"><span class="cl"><span class="s">     cm_wfd_atv ad,
</span></span></span><span class="line"><span class="cl"><span class="s">     cm_wfd_prc pd,
</span></span></span><span class="line"><span class="cl"><span class="s">     (select id,
</span></span></span><span class="line"><span class="cl"><span class="s">             atvi_id,
</span></span></span><span class="line"><span class="cl"><span class="s">             mtime,
</span></span></span><span class="line"><span class="cl"><span class="s">             sender,
</span></span></span><span class="line"><span class="cl"><span class="s">             stime,
</span></span></span><span class="line"><span class="cl"><span class="s">             (select count(1)
</span></span></span><span class="line"><span class="cl"><span class="s">              from cm_wfi_item
</span></span></span><span class="line"><span class="cl"><span class="s">              where atvi_id = t.atvi_id
</span></span></span><span class="line"><span class="cl"><span class="s">                    and Assign_Kind = 4
</span></span></span><span class="line"><span class="cl"><span class="s">                    and id &lt;&gt; t.id) as reCount
</span></span></span><span class="line"><span class="cl"><span class="s">     	from cm_wfi_item t
</span></span></span><span class="line"><span class="cl"><span class="s">     	where status = 1
</span></span></span><span class="line"><span class="cl"><span class="s">     	      and user_id = @p_userid
</span></span></span><span class="line"><span class="cl"><span class="s">     	      and (@p_start &lt; &#39;1900-01-01&#39; or mtime &gt;= @p_start)
</span></span></span><span class="line"><span class="cl"><span class="s">     	      and (@p_end &lt; &#39;1900-01-01&#39; or mtime &lt;= @p_end)) wi
</span></span></span><span class="line"><span class="cl"><span class="s"> where wi.atvi_id = ai.id
</span></span></span><span class="line"><span class="cl"><span class="s">       and ai.prci_id = pi.id
</span></span></span><span class="line"><span class="cl"><span class="s">       and pi.prcd_id = pd.id
</span></span></span><span class="line"><span class="cl"><span class="s">       and ai.atvd_id = ad.id
</span></span></span><span class="line"><span class="cl"><span class="s">       and (@p_status &gt; 2 or pi.status = @p_status)
</span></span></span><span class="line"><span class="cl"><span class="s"> order by wi.stime desc
</span></span></span><span class="line"><span class="cl"><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<h2 id="保存实体">保存实体</h2>
<p>实体持久化包括三种情况：单个实体对象的持久化、同一实体类型的实体列表的持久化、任意实体及实体列表的持久化。</p>
<p>前两种情况可通过扩展方法完成，这些扩展方法包括实体及实体列表的保存与删除，扩展方法参见<code>EntityEx</code>：
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// Entity扩展</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">EntityEx</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 保存实体数据，成功后：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. 实体状态复位 AcceptChanges &lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;待保存的实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示保存结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;是否成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量保存Table中新增、修改、删除的实体数据</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;删除行通过Table的ExistDeleted DeletedRows判断获取&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;保存成功后，对于每个保存的实体：&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. 实体状态复位 AcceptChanges &lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_tbl&#34;&gt;实体表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示保存结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;是否成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_tbl</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量保存实体数据，根据实体状态执行新增、修改</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;保存成功后，对于每个保存的实体：&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. 实体状态复位 AcceptChanges &lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_list&#34;&gt;待保存列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示保存结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;true 保存成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_list</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量保存一对多的父实体数据和所有子实体数据</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;保存成功后，对于每个保存的实体：&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. 实体状态复位 AcceptChanges &lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;父实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;待保存的父实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示保存结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;是否成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">SaveWithChild</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 删除实体，依靠数据库的级联删除自动删除子实体，成功后：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;待删除的实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示删除结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;true 删除成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Delete</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量删除Table的所有实体数据，成功后对于每个删除的实体：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_tbl&#34;&gt;待删除实体列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示删除结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;true 删除成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Delete</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_tbl</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量删除实体数据，成功后对于每个删除的实体：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 若已设置服务端缓存，则删除缓存&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_list&#34;&gt;待删除实体列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示删除结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;true 删除成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Delete</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_list</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 清除以某列为键名的实体缓存，键名组成：</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;表名:列名:列值&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_colName&#34;&gt;主键或唯一索引列名&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">ClearCache</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_colName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>不同类型的实体及实体列表在同一事务中持久化需在领域服务中完成，详见以下的<a href="#%e9%a2%86%e5%9f%9f%e6%9c%8d%e5%8a%a1" rel="">领域服务</a>。
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">原则上整个系统不允许出现含 <code>insert update delete</code> 的sql语句，增删改的sql语句都由系统自动生成。</div>
        </div>
    </div></p>
<h2 id="领域服务">领域服务</h2>
<p>每个模块都包含一个或多个领域服务类，主要处理涉及多种实体的交叉业务逻辑或无法确定放在何处的功能。</p>
<h3 id="客户端">客户端</h3>
<p>客户端领域服务类的命名以<code>Ds</code>为后缀，无状态，所有方法、属性、事件等都为静态，领域服务类继承自<code>DomainSvc&lt;T,T&gt;</code>。和<code>EntityX&lt;T&gt;</code>相同，将当前领域服务类作为泛型参数传递到基类，使每个领域服务类保证有一套只属于自己的静态变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 领域服务的抽象基类</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;typeparam name=&#34;TDomainSvc&#34;&gt;当前领域服务的类型，保证静态变量属于各自的领域服务类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;typeparam name=&#34;TAccessInfo&#34;&gt;用于获取IDataAccess对象&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DomainSvc</span><span class="p">&lt;</span><span class="n">TDomainSvc</span><span class="p">,</span> <span class="n">TAccessInfo</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TDomainSvc</span> <span class="p">:</span> <span class="k">class</span>
</span></span><span class="line"><span class="cl">    <span class="nc">where</span> <span class="n">TAccessInfo</span> <span class="p">:</span> <span class="n">AccessInfo</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*************************************************************************/</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 泛型类型：</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对象是类的实例，提供具体类型参数的泛型类是泛型类型的实例</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 若将当前类型作为泛型类的类型参数，如 AbcDs : DomainSvc&lt;AbcDs, Info&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 则AbcDs是该泛型基类的实例类，泛型基类中保证有一套只属于AbcDs类的静态变量实例！</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 因此类型参数相同的泛型类的静态成员相同</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**************************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 日志对象，日志属性中包含来源</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">_log</span> <span class="p">=</span> <span class="n">Log</span><span class="p">.</span><span class="n">ForContext</span><span class="p">&lt;</span><span class="n">TDomainSvc</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 获取领域层数据访问对象</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IDataAccess</span> <span class="n">_da</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TAccessInfo</span><span class="p">().</span><span class="n">GetDataAccess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>基类中只包含两个变量：<code>_log _da</code>，<code>_log</code>较于Log的优点是日志属性中包含来源:
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/9.png" width="397" height="300" /></p>
<p><code>_da</code>包含所有的数据访问方法，除普通的查询方法外，还包含获取实体写入器方法<code>NewWriter()</code>，该方法返回<code>IEntityWriter</code>，实体写入器对所有实体的的持久化做统一管理，解决领域模型存储和变更工作，使用写入器添加待保存和删除的实体或实体列表，最后调用写入器的<code>Commit</code>方法在一个事务内批量处理所有待保存、待删除的实体数据，失败时回滚！提交成功后，若存在领域事件，则发布事件；对于新增、修改的实体进行状态复位。</p>
<p>以上整个过程和同类型实体持久化相同，都是通过<code>IEntityWriter</code>实现：
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 实体写入器，对所有实体的的持久化做统一管理，解决领域模型存储和变更工作</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;para&gt;写入器在一个事务内批量处理所有待保存、待删除的实体数据，失败时回滚&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;para&gt;无论提交成功失败都清空状态，准备下次提交！&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">interface</span> <span class="nc">IEntityWriter</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 添加待保存的实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;待保存的实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 添加Table中新增、修改、删除的待保存实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;删除行通过Table的ExistDeleted DeletedRows判断获取&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_tbl&#34;&gt;实体表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">Table</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_tbl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 批量添加一对多的父实体和所有子实体中新增、修改、删除的待保存实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">SaveWithChild</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 添加列表中新增、修改的待保存实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_list&#34;&gt;实体列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 添加待删除的实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_entity&#34;&gt;待删除的实体&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">Delete</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">TEntity</span> <span class="n">p_entity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 批量添加待删除的实体，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_list&#34;&gt;待删除实体列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">Delete</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">p_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 先根据主键获取该实体，然后添加到待删除，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_id&#34;&gt;主键&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">DelByID</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="kt">object</span> <span class="n">p_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 先根据主键批量获取该实体，然后添加到待删除，最后由Commit统一提交</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;typeparam name=&#34;TEntity&#34;&gt;实体类型&lt;/typeparam&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_ids&#34;&gt;主键列表&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span> <span class="n">DelByIDs</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;(</span><span class="n">IList</span> <span class="n">p_ids</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 一个事务内批量处理所有待保存、待删除的实体数据，失败时回滚</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;无论提交成功失败都清空状态，准备下次提交！&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;处理成功后，对于每个实体：&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;1. 调用保存后或删除后回调&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;2. 对于新增或修改的实体进行状态复位&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;3. 若存在领域事件，则发布事件&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;param name=&#34;p_isNotify&#34;&gt;是否提示保存结果，客户端有效&lt;/param&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;returns&gt;是否成功&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Commit</span><span class="p">(</span><span class="kt">bool</span> <span class="n">p_isNotify</span> <span class="p">=</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>总体而言，<strong>客户端能处理绝大部分业务功能，无法实现或影响效率的功能还需要服务端实现</strong>。</p>
<h3 id="服务端">服务端</h3>
<p>服务端领域服务同时也是微服务的Api，是客户端提交请求的入口。为尽最大可能的使服务端与客户端代码通用，在实现上领域服务类继承自DomainSvc并带有Api标签，基类的方法和成员名称相同，但不是静态。
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// 领域服务的抽象基类，也是Rpc Api入口</span>
</span></span><span class="line"><span class="cl"><span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DomainSvc</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 获取领域层数据访问对象</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="n">IDataAccess</span> <span class="n">_da</span> <span class="p">=&gt;</span> <span class="n">_bag</span><span class="p">.</span><span class="n">DataAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 获取当前用户标识，UI客户端rpc为实际登录用户ID</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;para&gt;特殊标识：110为admin页面，111为RabbitMQ rpc，112为本地调用&lt;/para&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="kt">long</span> <span class="n">_userID</span> <span class="p">=&gt;</span> <span class="n">_bag</span><span class="p">.</span><span class="n">UserID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 日志对象，日志中比静态Log类多出Api名称和当前UserID</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="n">ILogger</span> <span class="n">_log</span> <span class="p">=&gt;</span> <span class="n">_bag</span><span class="p">.</span><span class="n">Log</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 当前http请求是否为匿名用户</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="kt">bool</span> <span class="n">_isAnonymous</span> <span class="p">=&gt;</span> <span class="n">_bag</span><span class="p">.</span><span class="n">UserID</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<h2 id="从row到entity">从Row到Entity</h2>
<p>数据对象是整个系统的基础，标准的DDD设计包含多种数据对象，基本上每层一种类型，如：
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/28.png" width="686" height="271" /></p>
<p>它的优势是各层之间可以自定义数据内容，降低各层之间的耦合，缺点是类型转换带来的资源消耗、系统的分裂感、代码及名称的繁琐，总体感觉太过于循规蹈矩。</p>
<p>本系统的数据对象需要满足以下使用场景：</p>
<ul>
<li>支持UI层的绑定(ViewMode)</li>
<li>自动生成实体代码</li>
<li>自定义序列化内容</li>
<li>从db加载数据时高性能不使用反射</li>
<li>反序列化时自动转换实体类型</li>
<li>充血模式的实体对象</li>
<li>数据持久化时转换成Sql</li>
</ul>
<p>为满足以上所有使用场景，采用<code>Row</code>作为基类，<code>Row</code>负责装载所有数据，内部通过数据项(<code>Cell</code>)集合的方式进行管理，<code>Table</code>是<code>Row</code>的集合类，并包含<code>Columns</code>属性，为满足领域中用到的实体对象，抽象类<code>Entity</code>继承自<code>Row</code>，所有实体类需要从<code>Entity</code>派生，泛型类<code>Table&lt;TEntity&gt;</code>继承自<code>Table</code>，泛型参数约束为实体类。
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/29.png" width="993" height="306" /></p>
<p>下面针对这些使用场景逐一说明：</p>
<h3 id="ui绑定">UI绑定</h3>
<p>Fv的数据源为<code>Row</code>时，<code>FvCell</code>数据源对应<code>Cell</code>，通过<code>Row.Cells[ID]</code>确定，绑定路径为固定的<code>Val</code>，<code>Row</code>实现接口<code>INotifyPropertyChanged</code>，确保双向绑定有效，如<code>IsChanged</code>属性绑定到保存按钮的<code>IsEnable</code>属性实现保存控制。
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/1.png" width="497" height="100" /></p>
<p>同样<code>Cell</code>也实现接口<code>INotifyPropertyChanged</code>，常用的绑定属性有：
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/2.png" width="365" height="237" /></p>
<p><code>Lv</code>或<code>Tv</code>的数据源为<code>Table</code>时，<code>Row</code>对应UI中的<code>ViewItem</code>，实际绑定到<code>LvRow</code>或<code>TvPanelItem</code>，<code>Cell</code>对应具体的可视元素，<code>Table</code>继承自<code>ObservableCollection&lt;Row&gt;</code>，能将行数的变化实时反应到UI上。
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/3.png" width="599" height="102" /></p>
<h3 id="生成实体代码">生成实体代码</h3>
<p>参见上述读写数据过程，业务开发时既可以使用<code>Table/Row</code>，也可以使用<code>Table&lt;Entity&gt;/Entity</code>，一般简单数据读写时使用<code>Table/Row</code>，包含业务逻辑时使用<code>Table&lt;Entity&gt;/Entity</code>，实体类代码分成两部分，一部分通过系统自动生成代码，主要为构造方法和属性，另一部分为业务逻辑，根据需求完成。为方便管理，自动生成的代码禁止修改，只修改业务逻辑的<code>partial classs</code>，参见<a href="#%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91" rel="">业务逻辑</a>。</p>
<p>自动生成实体代码需要提供实体类对应的表名，如下：
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/5.png" width="637" height="294" /></p>
<p>生成实体类代码如下：</p>
<p><img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/6.png" width="674" height="522" /></p>
<p>该实体类主要包括构造方法和属性，公共构造方法用于手动创建实体对象，方法参数除主键外其他参数都有默认值，默认值是数据库表结构中字段的默认值；属性和字段一一对应，所以属性类型都是<code>System</code>命名空间的简单类型，如<code>string long DateTime bool int byte</code>等，但不包括枚举类型。</p>
<p><strong>有两种类型需要特别关注：</strong><code>bool enum</code>。</p>
<p>对于<code>bool</code>类型：</p>
<ol>
<li>在mysql中自动对应<code>tinyint(1)</code>，无需额外处理；</li>
<li>oracle中自定义对应<code>char(1)</code>，值为<code>1 0</code>，需要平台特殊处理，<strong>生成实体类时自动将<code>#bool#</code>开始的注释当作bool类型</strong>；</li>
<li>sqlserver中自动对应<code>bit</code>，无需额外处理；</li>
<li>postgresql中自动对应<code>bool</code>，无需额外处理；</li>
<li>增删改语句内部已特殊处理，但sql查询语句需要注意，除pg中只能当作字符进行比较，其余都可当作数字进行比较！</li>
</ol>
<p>对于<code>enum</code>类型， 为了编码、查询、显示方便，平台自己增加并特殊处理了<code>enum</code>类型的情况：</p>
<ol>
<li>
<p>在mysql中将无符号<code>tinyint(4)</code>设计为enum类型，最多能存储256个成员，在程序中已够用，生成实体类时支持自动将<code>#EnumName#</code>开始的注释当作枚举类型，增加方便性和代码的可读性。如<code>Gender</code>(性别)枚举类型：
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/30.png" width="537" height="211" />
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/31.png" width="314" height="464" />
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/32.png" width="364" height="188" /></p>
</li>
<li>
<p>oracle中将<code>number(3)</code>设计为enum类型；</p>
</li>
<li>
<p>sqlserver中将<code>tinyint</code>设计为enum类型；</p>
</li>
<li>
<p>pg中将<code>int2</code>设计为enum类型；</p>
</li>
</ol>
<p>这样所有涉及对该实体类的sql查询、序列化反序列化，底层都会自动将数据转为对应的<code>enum</code>类型，减少很多重复的工作量，如sql查询中不再需要<code>case</code>语句，程序用于显示的地方显示<code>enum</code>成员名，保存时为<code>byte tinyint number 或 int2</code>值，编辑时下拉选项为所有<code>enum</code>成员。</p>
<p>oracle中<code>number</code>类型的c#类型的对应关系</p>
<ul>
<li><code>number(1-4)</code>　　<code>Int16/shot</code></li>
<li><code>number(5-9)</code>　　<code>Int32/int</code></li>
<li><code>number(10-19)</code>　<code>Int64/long</code></li>
<li><code>number(20-38)</code>　<code>decimal</code></li>
</ul>
<p>postgresql中类型和c#类型的对应关系
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">Postgresql</span>   <span class="err">.Net</span> <span class="err">System</span> <span class="err">Type</span>
</span></span><span class="line"><span class="cl"><span class="err">----------</span>   <span class="err">----------------</span>
</span></span><span class="line"><span class="cl"><span class="err">int</span><span class="mi">8</span>         <span class="err">Int</span><span class="mi">64</span>
</span></span><span class="line"><span class="cl"><span class="err">int</span><span class="mi">4</span>         <span class="err">Int</span><span class="mi">32</span>
</span></span><span class="line"><span class="cl"><span class="err">int</span><span class="mi">2</span>         <span class="err">Int</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="err">float</span><span class="mi">8</span>       <span class="err">Double</span>
</span></span><span class="line"><span class="cl"><span class="err">float</span><span class="mi">4</span>       <span class="err">Single</span>
</span></span><span class="line"><span class="cl"><span class="err">bool</span>         <span class="err">Boolean</span>
</span></span><span class="line"><span class="cl"><span class="err">varchar</span>      <span class="err">String</span>
</span></span><span class="line"><span class="cl"><span class="err">text</span>         <span class="err">String</span>
</span></span><span class="line"><span class="cl"><span class="err">bytea</span>        <span class="err">Byte</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="err">date</span>         <span class="err">DateTime</span>
</span></span><span class="line"><span class="cl"><span class="err">money</span>        <span class="err">Decimal</span>
</span></span><span class="line"><span class="cl"><span class="err">numeric</span>      <span class="err">Decimal</span>
</span></span><span class="line"><span class="cl"><span class="err">time</span>         <span class="err">DateTime</span>
</span></span><span class="line"><span class="cl"><span class="err">timetz</span>       <span class="err">DateTime</span>
</span></span><span class="line"><span class="cl"><span class="err">timestamp</span>    <span class="err">DateTime</span>
</span></span><span class="line"><span class="cl"><span class="err">timestamptz</span>  <span class="err">DateTime</span>
</span></span><span class="line"><span class="cl"><span class="err">interval</span>     <span class="err">TimeSpan</span>
</span></span><span class="line"><span class="cl"><span class="err">inet</span>         <span class="err">IPAddress</span>
</span></span><span class="line"><span class="cl"><span class="err">bit</span>          <span class="err">Boolean</span>
</span></span><span class="line"><span class="cl"><span class="err">uuid</span>         <span class="err">Guid</span>
</span></span><span class="line"><span class="cl"><span class="err">array</span>        <span class="err">Array</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<h3 id="自定义序列化">自定义序列化</h3>
<p>数据对象需要在客户端与服务端之间、服务与服务之间传输，序列化时需要保证数据的完整、简洁，以下为<code>Table</code> <code>Row</code>序列化为<code>json</code>时的结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="c1">// Row
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;#row&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;新建/修改状态&#34;</span><span class="p">,</span> <span class="c1">// 可能没有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;key1&#34;</span><span class="p">:</span> <span class="s2">&#34;当前值&#34;</span><span class="p">,</span> <span class="c1">// string类型，值无变化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nt">&#34;key2&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;类型&#34;</span><span class="p">,</span> <span class="s2">&#34;当前值&#34;</span><span class="p">],</span> <span class="c1">// 非string类型，值无变化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nt">&#34;key3&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;类型&#34;</span><span class="p">,</span> <span class="s2">&#34;当前值&#34;</span><span class="p">,</span> <span class="s2">&#34;原始值&#34;</span><span class="p">],</span> <span class="c1">// 值变化时传递完整信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;#tbl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列名1&#34;</span>  <span class="c1">// string类型省略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">],</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列名2&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列类型&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列名3&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列类型&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span> 
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">[</span><span class="s2">&#34;列1原始值&#34;</span><span class="p">,</span><span class="s2">&#34;列1当前值&#34;</span><span class="p">],</span> <span class="c1">// 值变化时传递两值数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="mi">12</span><span class="p">,</span>     <span class="c1">// 无变化时只传单值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s2">&#34;2016-10-18T09:08:22.702351+08:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s2">&#34;Added/Modified&#34;</span> <span class="c1">// 多出的列为行状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">],</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;列1值&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;2016-10-18T09:08:22.702351+08:00&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span> 
</span></span><span class="line"><span class="cl">        <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="mi">33</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div>
<h3 id="高性能加载数据">高性能加载数据</h3>
<p>普通<code>ORM</code>从数据库读取数据、加载数据时一般通过反射创建实体对象、进行属性赋值，本系统采用的方式不同，因基类<code>Row</code>通过数据项集合的方式管理数据，实体类属性并不直接对应变量，所以添加数据时不需要通过反射的方式对属性赋值，而是向集合增加数据项即可，参见以下：
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="hl"><span class="lnt">51
</span></span><span class="lnt">52
</span><span class="hl"><span class="lnt">53
</span></span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl">        <span class="k">async</span> <span class="n">Task</span> <span class="n">QueryInternal</span><span class="p">&lt;</span><span class="n">TRow</span><span class="p">&gt;(</span><span class="n">Table</span> <span class="n">p_tbl</span><span class="p">,</span> <span class="kt">string</span> <span class="n">p_keyOrSql</span><span class="p">,</span> <span class="kt">object</span> <span class="n">p_params</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">where</span> <span class="n">TRow</span> <span class="p">:</span> <span class="n">Row</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">cmd</span> <span class="p">=</span> <span class="n">CreateCommand</span><span class="p">(</span><span class="n">p_keyOrSql</span><span class="p">,</span> <span class="n">p_params</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="n">OpenConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">wrappedReader</span> <span class="p">=</span> <span class="p">(</span><span class="n">IWrappedDataReader</span><span class="p">)</span><span class="k">await</span> <span class="n">_conn</span><span class="p">.</span><span class="n">ExecuteReaderAsync</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Dapper2.0 改版</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MySqlDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="p">(</span><span class="n">MySqlDataReader</span><span class="p">)</span><span class="n">wrappedReader</span><span class="p">.</span><span class="n">Reader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// Entity类型</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Type</span> <span class="n">tpEntity</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TRow</span><span class="p">).</span><span class="n">IsSubclassOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Entity</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">tpEntity</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TRow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1">// 参见github上的MySqlDataReader.cs</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 获取列定义</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">var</span> <span class="n">cols</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetColumnSchema</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">col</span> <span class="k">in</span> <span class="n">cols</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">AllowDBNull</span><span class="p">.</span><span class="n">HasValue</span> <span class="p">&amp;&amp;</span> <span class="n">col</span><span class="p">.</span><span class="n">AllowDBNull</span><span class="p">.</span><span class="n">Value</span> <span class="p">&amp;&amp;</span> <span class="n">col</span><span class="p">.</span><span class="n">DataType</span><span class="p">.</span><span class="n">IsValueType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// 可为null的值类型</span>
</span></span><span class="line"><span class="cl">                            <span class="n">p_tbl</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">DataType</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">DataType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">tpEntity</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// Entity 时根据属性类型将 byte 自动转为 enum 类型</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">var</span> <span class="n">prop</span> <span class="p">=</span> <span class="n">tpEntity</span><span class="p">.</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">DeclaredOnly</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="n">p_tbl</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">,</span> <span class="n">prop</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">prop</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">:</span> <span class="n">col</span><span class="p">.</span><span class="n">DataType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">p_tbl</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">col</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">,</span> <span class="n">col</span><span class="p">.</span><span class="n">DataType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">while</span> <span class="p">(</span><span class="k">await</span> <span class="n">reader</span><span class="p">.</span><span class="n">ReadAsync</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 整行已读到内存，官方推荐使用同步方法获取值，比异步性能更好！</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 无参数构造方法可能为private，如实体类型</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">var</span> <span class="n">row</span> <span class="p">=</span> <span class="p">(</span><span class="n">TRow</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TRow</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">reader</span><span class="p">.</span><span class="n">FieldCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">var</span> <span class="n">col</span> <span class="p">=</span> <span class="n">p_tbl</span><span class="p">.</span><span class="n">Columns</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">IsDBNull</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line hl"><span class="cl">                                <span class="k">new</span> <span class="n">Cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">col</span><span class="p">.</span><span class="n">Type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="k">else</span>
</span></span><span class="line hl"><span class="cl">                                <span class="k">new</span> <span class="n">Cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">col</span><span class="p">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="n">p_tbl</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="n">GetSqlException</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReleaseConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></p>
<h3 id="自动类型转换">自动类型转换</h3>
<p>为避免数据对象在客户端与服务端之间、各层之间的耦合性，采用降型传输的方式，即将实体类型降低为<code>Row</code>传输，反序列化时再根据实际情况创建新的实体对象，比如客户端实体类<code>UserA</code>，在保存实体数据时以<code>Row</code>类型传输到服务端，反序列化时创建实体对象<code>UserB</code>，类型<code>UserA</code>和<code>UserB</code>分属两端，各自独立使用，无任何代码上的耦合，但数据内容是相同的或相交的，这样既降低实体类型的耦合性也减少实体类型转换带来的冗余操作。</p>
<p><img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/36.png" width="705" height="759" /></p>
<p>由上图可见，两个实体类型不论数据相同还是相交，<code>Row</code>都应该提供两个实体的完整数据。</p>
<h3 id="转换成sql">转换成Sql</h3>
<p>在生成实体类型代码时通过<code>Tbl</code>标签已指定映射的表名/视图名，实体对象在使用过程中自动记录数据变化及状态(如<code>IsAdded</code>, <code>IsChanged</code>)，在传输过程未丢失任何信息，客户端和服务端都可以将实体对象生成要执行的Sql语句，生成Sql过程请参见<code>TableSchema.cs</code>文件，客户端公共Api的“写数据”就是在客户端生成的Sql语句。</p>
<h2 id="实体缓存">实体缓存</h2>
<div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">实体缓存适用于<strong>频繁使用并且基本无修改</strong>的实体，其它情况请谨慎使用缓存。</div>
        </div>
    </div>
<p>实体缓存涉及两方面内容：<code>GetFromCacheFirst</code>用于优先从缓存读取实体
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/19.png" width="776" height="202" /></p>
<p>实体修改或删除后需要清除缓存，可在实体类的<code>InitHook</code>的<code>OnSaved OnDeleted</code>回调中清除，如：
<img class="lazyload" src="/dt-docs/svg/loading.min.svg" data-src="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png" data-srcset="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png 1.5x, /dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png 2x" data-sizes="auto" alt="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png" title="/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/20.png" width="527" height="158" /></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <section class="post-tags"></section>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://daotingh.gitee.io/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/" data-title="领域层"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://daotingh.gitee.io/dt-docs/docs/2%E5%9F%BA%E7%A1%80/3%E9%A2%86%E5%9F%9F%E5%B1%82/" data-title="领域层"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/baidu.svg" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>
</div>
</article><div class="toc" id="toc-auto">
                <h2 class="toc-title">目录</h2>
                <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#实体">实体</a></li>
    <li><a href="#业务逻辑">业务逻辑</a></li>
    <li><a href="#构造实体">构造实体</a></li>
    <li><a href="#保存实体">保存实体</a></li>
    <li><a href="#领域服务">领域服务</a>
      <ul>
        <li><a href="#客户端">客户端</a></li>
        <li><a href="#服务端">服务端</a></li>
      </ul>
    </li>
    <li><a href="#从row到entity">从Row到Entity</a>
      <ul>
        <li><a href="#ui绑定">UI绑定</a></li>
        <li><a href="#生成实体代码">生成实体代码</a></li>
        <li><a href="#自定义序列化">自定义序列化</a></li>
        <li><a href="#高性能加载数据">高性能加载数据</a></li>
        <li><a href="#自动类型转换">自动类型转换</a></li>
        <li><a href="#转换成sql">转换成Sql</a></li>
      </ul>
    </li>
    <li><a href="#实体缓存">实体缓存</a></li>
  </ul>
</nav></div>
            </div></div>
    </div>
</div>
            </main>
            <footer class="footer">
                <div class="footer-container"><div class="footer-line">搬运工</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/dt-docs/" target="_blank">Daoting</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
                </div>
            </footer>
        </div>

        <div id="fixed-buttons">
            <a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
            <a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"lightgallery":true,"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/dt-docs/js/theme.min.js"></script>
    </body>
</html>
